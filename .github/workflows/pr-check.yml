# ========================================
# GITHUB ACTIONS PR CHECK WORKFLOW
# ========================================
# 
# Workflow kiá»ƒm tra Pull Request:
# - Code quality check
# - Build verification
# - Preview deployment
# - Cháº¡y trÃªn má»i PR
#
# Triggers:
# - pull_request: any branch

name: ğŸ” PR Quality Check

on:
  # PULL REQUEST TRIGGERS - KÃCH HOáº T KHI CÃ“ PR
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  
  # MANUAL TRIGGER - KÃCH HOáº T THá»¦ CÃ”NG
  workflow_dispatch:

# ENVIRONMENT - MÃ”I TRÆ¯á»œNG
env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # JOB 1: CODE QUALITY - KIá»‚M TRA CHáº¤T LÆ¯á»¢NG CODE
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
      
      - name: ğŸ” ESLint check
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint:check
        continue-on-error: true
      
      - name: ğŸ’„ Prettier check
        run: |
          echo "ğŸ’„ Running Prettier check..."
          npm run format:check
        continue-on-error: true
      
      - name: ğŸ“Š Overall quality check
        run: |
          echo "ğŸ“Š Running comprehensive quality checks..."
          npm run quality
        continue-on-error: true
      
      - name: ğŸ“‹ Upload quality results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-results-${{ github.event.number }}
          path: |
            .eslintcache
          retention-days: 3

  # JOB 2: BUILD VERIFICATION - KIá»‚M TRA BUILD
  build-check:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout PR code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build project
        run: |
          echo "ğŸ—ï¸ Building project..."
          npm run build
        continue-on-error: true
      
      - name: ğŸ“Š Build analysis
        run: |
          echo "ğŸ“Š Build analysis:"
          if [ -d "dist" ]; then
            echo "âœ… Build successful"
            ls -la dist/
            echo "ğŸ“ Build size:"
            du -sh dist/
            echo "ğŸ“ Build contents:"
            find dist/ -type f | head -10
          else
            echo "âŒ Build failed - no dist directory"
            exit 1
          fi
        continue-on-error: true
      
      - name: ğŸ“‹ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-preview-${{ github.event.number }}
          path: dist/
          retention-days: 3

  # JOB 3: PREVIEW DEPLOYMENT - TRIá»‚N KHAI PREVIEW
  preview-deploy:
    name: ğŸ‘ï¸ Preview Deployment
    runs-on: ubuntu-latest
    needs: [code-quality, build-check]
    if: always() && (needs.code-quality.result == 'success' || needs.build-check.result == 'success')
    
    steps:
      - name: ğŸ“¥ Checkout PR code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build for preview
        run: npm run build
      
      - name: ğŸ“‹ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-preview-${{ github.event.number }}
          path: dist/
      
      - name: ğŸ‘ï¸ Deploy preview to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.event.pull_request.head.repo.full_name == github.repository
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/
          destination_dir: preview/pr-${{ github.event.number }}
      
      - name: ğŸ“¢ Preview deployment success
        run: |
          echo "ğŸ‰ Preview deployed!"
          echo "ğŸ‘ï¸ Preview URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview/pr-${{ github.event.number }}/"
          echo "ğŸ”— PR: ${{ github.event.pull_request.html_url }}"

  # JOB 4: PR SUMMARY - TÃ“M Táº®T PR
  pr-summary:
    name: ğŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, build-check, preview-deploy]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate PR Summary
        run: |
          echo "ğŸ“‹ PULL REQUEST SUMMARY"
          echo "======================"
          echo "ğŸ¯ PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.pull_request.head.ref }}"
          echo "ğŸ“… Created: ${{ github.event.pull_request.created_at }}"
          echo "======================"
          echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
          echo "ğŸ—ï¸ Build Check: ${{ needs.build-check.result }}"
          echo "ğŸ‘ï¸ Preview Deploy: ${{ needs.preview-deploy.result }}"
          echo "======================"
          
          if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.build-check.result }}" == "success" ]]; then
            echo "âœ… All checks passed! Ready for review."
            if [[ "${{ needs.preview-deploy.result }}" == "success" ]]; then
              echo "ğŸ‘ï¸ Preview available for testing."
            fi
          elif [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
            echo "âŒ Code quality issues found. Please fix ESLint/Prettier errors."
          elif [[ "${{ needs.build-check.result }}" == "failure" ]]; then
            echo "âŒ Build failed. Please check the build logs."
          else
            echo "âš ï¸ Some checks failed. Please review the logs."
          fi
      
      - name: ğŸ“Š Upload PR artifacts summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-summary-${{ github.event.number }}
          path: |
            .eslintcache
          retention-days: 3
